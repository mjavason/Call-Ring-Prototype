<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sip.js/dist/sip.min.js"></script>
  </head>
  <body>
    <h1>WebRTC Call</h1>
    <input type="text" id="userId" placeholder="Your ID" />
    <input type="text" id="calleeId" placeholder="Callee ID" />
    <button id="register">Register</button>
    <button id="call">Call</button>
    <button id="hangup">Hang Up</button>
    <video id="remoteVideo" autoplay></video>

    <script>
      const socket = io('http://localhost:3000');
      let userId;
      let calleeId;

      const peerConnection = new RTCPeerConnection();
      const remoteVideo = document.getElementById('remoteVideo');

      peerConnection.ontrack = (event) => {
        console.log('Received remote track event:', event);
        remoteVideo.srcObject = event.streams[0];
        console.log('Remote video stream set.');
      };

      // Register the user with the server
      document.getElementById('register').onclick = () => {
        userId = document.getElementById('userId').value;
        console.log('Register button clicked. User ID:', userId);
        socket.emit('register', userId);
        console.log('Sent register event to server.');
      };

      // Handling incoming signals
      socket.on('signal', async (data) => {
        console.log('Signal received:', data);
        if (data.type === 'offer') {
          console.log('Received offer from:', data.from);
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(data)
          );
          console.log('Set remote description with the received offer.');

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          console.log('Created and set local description with answer.');

          socket.emit('signal', {
            type: 'answer',
            sdp: peerConnection.localDescription.sdp,
            to: data.from,
            from: userId,
          });
          console.log('Sent answer to:', data.from);
        } else if (data.type === 'answer') {
          console.log('Received answer from:', data.from);
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(data)
          );
          console.log('Set remote description with the received answer.');
        } else if (data.type === 'candidate') {
          ////////////////////////////////////////////////////////////////
          console.log('Received ICE candidate from:', data.from);
          await peerConnection.addIceCandidate(
            new RTCIceCandidate(data.candidate)
          );
          console.log('Added ICE candidate.');
        }
      });

      // Creating the call
      document.getElementById('call').onclick = async () => {
        calleeId = document.getElementById('calleeId').value;
        console.log('Call button clicked. Callee ID:', calleeId);

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        console.log('Created and set local description with offer.');

        socket.emit('signal', {
          type: 'offer',
          sdp: peerConnection.localDescription.sdp,
          from: userId,
          to: calleeId,
        });
        console.log('Sent offer to:', calleeId);
      };

      // Hanging up the call
      document.getElementById('hangup').onclick = () => {
        console.log('Hang Up button clicked. Closing peer connection.');
        peerConnection.close();
        console.log('Peer connection closed.');
      };

      // ICE candidates
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log('Sending ICE candidate to:', calleeId);
          socket.emit('signal', {
            type: 'candidate',
            candidate: event.candidate,
            to: calleeId,
            from: userId,
          });
        }
      };
    </script>
  </body>
</html>
